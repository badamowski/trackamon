var app=angular.module("trackamon",["ngRoute"]);app.controller("ParentController",function($scope){}),app.controller("HomeController",function($scope){var currentLocationMarker,map,latitudeDifference,longitudeDifference,maxLatitudeNorth,maxLatitudeSouth,maxLongitudeEast,maxLongitudeWest,appearancePoints=[],disappearancePoints=[],appearanceOrDisappearance=[],squares=[],tracking=!1,accuracy=10,range=200,distanceForAppearance=(range+accuracy)/accuracy,distanceForDisappearance=(range-accuracy)/accuracy,clearButton=$('<button class="btn btn-raised btn-danger btn-lg"><i class="fa fa-times-circle" aria-hidden="true"></i> Clear</button>'),sightingButton=$('<button class="btn btn-raised btn-success btn-lg"><i class="fa fa-crosshairs" aria-hidden="true"></i> Sighting</button>'),disappearedButton=$('<button class="btn btn-raised btn-warning btn-lg"><i class="fa fa-ban" aria-hidden="true"></i> Disappeared</button>'),helpButton=$('<button class="btn btn-raised btn-lg"><i class="fa fa-question-circle-o" aria-hidden="true"></i> Help</button>'),refreshButton=$('<button class="btn btn-raised btn-info btn-lg"><i class="fa fa-refresh" aria-hidden="true"></i> Re-Draw</button>'),undoButton=$('<button class="btn btn-raised btn-danger btn-lg"><i class="fa fa-undo" aria-hidden="true"></i> Undo</button>');$scope.init=function(){findCurrentLocation(loadInitialMap),$(window).on("orientationchange",function(event){$scope.refresh()})},$scope.addTrackingPoint=function(){showLoading(),findCurrentLocation(addTrackingPointAtPosition)},$scope.addDisappearedPoint=function(){showLoading(),findCurrentLocation(addDisappearedPointAtPosition)},$scope.clearTracking=function(){_.each(squares,function(square){square.rectangle.setMap(null)}),squares=[],tracking=!1,appearancePoints=[],disappearancePoints=[],appearanceOrDisappearance=[],map.controls[google.maps.ControlPosition.TOP_RIGHT].pop(),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].pop(),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].pop()},$scope.openHelp=function(){$("#help-modal").modal()},$scope.refresh=function(){_.each(squares,function(square){square.rectangle.setMap(null)}),_.each(squares,function(square){square.active&&square.rectangle.setMap(map)}),findCurrentLocation(centerOnCurrentLocation)},$scope.undo=function(){var undoSquare,appearance=appearanceOrDisappearance.pop();undoSquare=appearance?appearancePoints.pop():disappearancePoints.pop(),console.log("TODO")},track=function(coordinate,isAppearance){var maxLat=coordinate.lat,maxLng=coordinate.lng,minLat=coordinate.lat,minLng=coordinate.lng;_.each(squares,function(square){if(square.active){var latitudeLength=(square.centerLatitude-coordinate.lat)/latitudeDifference,longitudeLength=(square.centerLongitude-coordinate.lng)/longitudeDifference,distanceToCenter=Math.sqrt(latitudeLength*latitudeLength+longitudeLength*longitudeLength);isAppearance&&distanceToCenter>distanceForAppearance||!isAppearance&&distanceToCenter<distanceForDisappearance?(square.rectangle.setMap(null),square.active=!1):(square.north>maxLat&&(maxLat=square.north),square.south<minLat&&(minLat=square.south),square.east>maxLng&&(maxLng=square.east),square.west<minLng&&(minLng=square.west))}})},buildStartingSquares=function(coordinate){latitudeDifference=coordinate.lat-geolib.computeDestinationPoint(coordinate,accuracy,0).latitude,longitudeDifference=coordinate.lng-geolib.computeDestinationPoint(coordinate,accuracy,90).longitude,maxLatitudeNorth=geolib.computeDestinationPoint(coordinate,range,0).latitude,maxLatitudeSouth=geolib.computeDestinationPoint(coordinate,range,180).latitude,maxLongitudeEast=geolib.computeDestinationPoint(coordinate,range,90).longitude,maxLongitudeWest=geolib.computeDestinationPoint(coordinate,range,270).longitude,latitudeDifference<0&&(latitudeDifference*=-1),longitudeDifference<0&&(longitudeDifference*=-1),drawSquaresHorizontal(maxLongitudeWest,maxLongitudeEast,longitudeDifference,maxLatitudeSouth,maxLatitudeNorth,latitudeDifference)},drawSquaresHorizontal=function(startinglongitude,endingLongitude,longitudeDifference,startingLatitude,maxLatitudeNorth,latitudeDifference){for(var maxLatitude=startingLatitude+latitudeDifference;startinglongitude<endingLongitude;){var nextLongitude=startinglongitude+longitudeDifference;drawSquare(maxLatitude,startingLatitude,nextLongitude,startinglongitude),drawSquaresVertical(maxLatitude,maxLatitudeNorth,latitudeDifference,startinglongitude,longitudeDifference),startinglongitude=nextLongitude}},drawSquaresVertical=function(startingLatitude,endingLatitude,latitudeDifference,startinglongitude,longitudeDifference){for(var maxLongitude=startinglongitude+longitudeDifference;startingLatitude<endingLatitude;){var nextLatitude=startingLatitude+latitudeDifference;drawSquare(nextLatitude,startingLatitude,maxLongitude,startinglongitude),startingLatitude=nextLatitude}},drawSquare=function(north,south,east,west){var rectangle=new google.maps.Rectangle({strokeWeight:0,fillColor:"#00FF00",fillOpacity:.35,map:map,bounds:{north:north,south:south,east:east,west:west}});squares.push({active:!0,north:north,south:south,east:east,west:west,centerLatitude:(north+south)/2,centerLongitude:(east+west)/2,rectangle:rectangle})},findCurrentLocation=function(callback){navigator.geolocation?navigator.geolocation.getCurrentPosition(callback):$scope.message="Geolocation is not supported by this browser."},centerOnCurrentLocation=function(position){var coordinate={lat:position.coords.latitude,lng:position.coords.longitude};currentLocationMarker.setPosition(coordinate)},loadInitialMap=function(position){var coordinate={lat:position.coords.latitude,lng:position.coords.longitude};map=new google.maps.Map(document.getElementById("map"),{center:coordinate,mapTypeId:"satellite",zoom:16,streetViewControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.LEFT_BOTTOM}}),currentLocationMarker=new google.maps.Marker({position:coordinate,icon:{path:google.maps.SymbolPath.CIRCLE,scale:5,fillColor:"#00BFFF",fillOpacity:1,strokeColor:"#00BFFF",strokeOpacity:1,zIndex:20},draggable:!1,map:map}),sightingButton.bind("click",$scope.addTrackingPoint),disappearedButton.bind("click",$scope.addDisappearedPoint),clearButton.bind("click",$scope.clearTracking),helpButton.bind("click",$scope.openHelp),refreshButton.bind("click",$scope.refresh),undoButton.bind("click",$scope.undo),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(sightingButton[0]),map.controls[google.maps.ControlPosition.TOP_CENTER].push(helpButton[0]),sessionStorage.getItem("TrackEmAll")||($("#help-modal").modal(),sessionStorage.setItem("TrackEmAll",!0))},addTrackingPointAtPosition=function(position){var coordinate={lat:position.coords.latitude,lng:position.coords.longitude};tracking||(buildStartingSquares(coordinate),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(clearButton[0]),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(disappearedButton[0]),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(refreshButton[0]),map.setCenter(coordinate),tracking=!0),appearancePoints.push(coordinate),appearanceOrDisappearance.push(!0),track(coordinate,!0),currentLocationMarker.setPosition(coordinate),hideLoading()},addDisappearedPointAtPosition=function(position){var coordinate={lat:position.coords.latitude,lng:position.coords.longitude};disappearancePoints.push(coordinate),appearanceOrDisappearance.push(!1),track(coordinate,!1),currentLocationMarker.setPosition(coordinate),hideLoading()},showLoading=function(){$(".loading-background").show()},hideLoading=function(){$(".loading-background").hide()}}),initMap=function(){},app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"pages/home.html",controller:"HomeController"}).otherwise({redirectTo:"/"})});